<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>FOAG System Map</title>
  <!-- Load Google Font-->Â¨
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
  <!-- Vis Network -->
  <script src="https://unpkg.com/vis-network@9.1.2/standalone/umd/vis-network.min.js"></script>
  <style>
    html, body {
      width: 100%;
      height: 100%;
      margin: 0;
      padding: 0;
      font-family: sans-serif;
    }
    #network {
      width: 100%;
      height: 100%;
      box-sizing: border-box;
    }
    .vis-tooltip {
      background: #ffffff !important; /* Dark background */
      padding: 8px 12px !important;
      border-radius: 3px !important;
      font-family: "Poppins", sans-serif !important; /* Use Google Font */
      font-size: 14px !important;
      word-wrap: break-word !important;
    }
  </style>
</head>
<body>

<div id="network"></div>

<script>
// -------------------------------------------------------------------
// 1) Helper function to create HTML tooltips for Vis
// -------------------------------------------------------------------
function htmlTitle(htmlString) {
  const container = document.createElement("div");
  container.innerHTML = htmlString;
  return container;
}

// -------------------------------------------------------------------
// 2) Define the SPARQL queries
//    (Adjust them as needed; these are the user-provided queries.)
// -------------------------------------------------------------------

const lang = "de";

const NODE_QUERY = `
PREFIX rdfs: <http://www.w3.org/2000/01/rdf-schema#>
PREFIX owl: <http://www.w3.org/2002/07/owl#>
PREFIX systemmap: <https://agriculture.ld.admin.ch/foag/system-map#>
SELECT ?id ?group ?label ?comment ?abbreviation
WHERE {
  GRAPH <https://lindas.admin.ch/foag/ontologies> {
    ?id a ?group .
    ?group rdfs:subClassOf* ?supergroup .
    VALUES ?supergroup { systemmap:CLS001 systemmap:CLS002 systemmap:CLS003 }
    ?id rdfs:label ?label .
    FILTER(LANG(?label) = "${lang}")
    OPTIONAL {
      ?id rdfs:comment ?comment .
      FILTER(LANG(?comment) = "${lang}")
    }
    OPTIONAL {
      ?id ?hasAbbreviation ?abbreviation .
      FILTER(LANG(?abbreviation) = "${lang}")
      VALUES ?hasAbbreviation { systemmap:PRP101 systemmap:PRP102 }
    }
  }
}
`;

const EDGE_QUERY = `
PREFIX rdfs: <http://www.w3.org/2000/01/rdf-schema#>
PREFIX owl: <http://www.w3.org/2002/07/owl#>
SELECT (?property AS ?id) ?from ?to ?label ?comment
WHERE {
  GRAPH <https://lindas.admin.ch/foag/ontologies> {
    ?from ?property ?to .
    ?property a owl:ObjectProperty .
    ?property rdfs:label ?label .
    FILTER(LANG(?label)="${lang}")
    OPTIONAL {
        ?property rdfs:comment ?comment .
        FILTER(LANG(?comment)="${lang}")
    }
  }
}
`;

// -------------------------------------------------------------------
// 3) Fetch data from LINDAS
// -------------------------------------------------------------------
const ENDPOINT = "https://test.lindas.admin.ch/query";

async function getSparqlData(query) {
  const url = `${ENDPOINT}?query=${encodeURIComponent(query)}`;
  const response = await fetch(url, {
    headers: { "Accept": "application/sparql-results+json" }
  });
  return response.json();
}

// Map the IRIs for classes onto simpler group names:
function mapClassIriToGroup(iri) {
  // Adjust these mappings if your IRIs differ
  switch (iri) {
    case "https://agriculture.ld.admin.ch/foag/system-map#CLS001":
      return "Organization";
    case "https://agriculture.ld.admin.ch/foag/system-map#CLS002":
      return "System";
    case "https://agriculture.ld.admin.ch/foag/system-map#CLS003":
      return "Information";
    default:
      return "Other";
  }
}

// -------------------------------------------------------------------
// 4) Build the Vis `nodes` and `edges` from the fetched data
// -------------------------------------------------------------------
async function init() {
  // Fetch node and edge data
  const nodesJson = await getSparqlData(NODE_QUERY);
  const edgesJson = await getSparqlData(EDGE_QUERY);

  // Function to insert line breaks every N characters
  const insertLineBreaks = (text, maxLineLength = 75) => {
    return text.replace(new RegExp(`(.{1,${maxLineLength}})(\\s|$)`, 'g'), "$1<br>");
  };

  const shortenLabel = (label, abbreviation) => {
    if (label.length <= 40) {
        return label;
    }
    if (abbreviation) {
        return `<b>${abbreviation}</b>`;
    }
    return label.substring(0, 40) + "...";
  };

  // Parse node results
  const nodes = nodesJson.results.bindings.map(row => {
    const iri = row.id.value;
    const groupIri = row.group.value;
    const label = row.label.value;
    const comment = row.comment ? row.comment.value : "";
    const abbreviation = row.abbreviation ? row.abbreviation.value : "";

    const groupName = mapClassIriToGroup(groupIri);
    const displayLabel = abbreviation || label;

    const header = insertLineBreaks(`${label} ${abbreviation ? `(${abbreviation})` : ""}`);

    return {
      id: iri,        // or you could hash this if needed
      label: shortenLabel(label, abbreviation),
      group: groupName,
      title: htmlTitle(`
      <tt><a href='${iri}'>${iri}</a></tt>
      <h3>${header}</h3>
      ${insertLineBreaks(comment)}
    `)
    };
  });

  // Parse edge results
  const edges = edgesJson.results.bindings.map(row => {
    const iri = row.id.value;
    const from = row.from.value;
    const to = row.to.value;
    const propertyLabel = row.label.value;
    const propertyComment = row.comment ? row.comment.value : "";

    return {
      from: from,
      to: to,
      label: propertyLabel,
      title: htmlTitle(`
        <tt><a href='${iri}'>${iri}</a></tt>
        <h3>${propertyLabel}</h3>
        ${propertyComment ? `${insertLineBreaks(propertyComment)}` : ""}
      `)
    };

  });

  // -------------------------------------------------------------------
  // 5) Render the network
  // -------------------------------------------------------------------
  const container = document.getElementById("network");
  const data = { nodes, edges };

  const options = {
    nodes: {
      widthConstraint: { minimum: 200, maximum: 200 }, // Increase box width
      heightConstraint: { minimum: 30, maximum: 30 },  // Increase box height
      shape: "box",
      font: { color: "#000000", face: "Poppins", multi: "html" }
    },
    edges: {
      font: {face: "Poppins"},
      arrows: {
        to: { enabled: true },
        from: { enabled: false }
      }
    },
    groups: {
      System: {
        color: {
          background: "#000000",  // light blue
          border: "#000000"
        },
        font: { color: "#FFFFFF" },
      },
      Information: {
        color: {
          background: "#A6C6DE",
          border: "#000000"
        }
      },
      Other: {
        color: { background: "#FFFFFF", border: "#000000" }
      }
    },
    interaction: {
      hover: true,
      dragNodes: true,  // Allow manual rearranging
      zoomView: true,
      dragView: true
    },
    physics: {
      enabled: true,
      barnesHut: {
        gravitationalConstant: -2000, // Increase repulsion
        centralGravity: 0.2,
        springLength: 300,  // Increase the default edge length
        springConstant: 0.05
      },
      stabilization: { iterations: 1000 }
    }

  };

  const network = new vis.Network(container, data, options);

  network.fit();
}

// Kick it off
init();
</script>
</body>
</html>
