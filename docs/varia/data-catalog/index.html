<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LINDAS System Map</title>

    <script src="https://cdn.jsdelivr.net/npm/jsonld@8.2.0/dist/jsonld.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">

    <style>
        :root {
            --bg-body: #f8f9fa;
            --bg-card: #ffffff;
            --text-primary: #1a1a1a;
            --text-secondary: #6c757d;
            --accent-color: #0d6efd;
            --tag-sys-bg: #e7f1ff;
            --tag-sys-text: #0d6efd;
            --tag-alert-bg: #fff3cd;
            --tag-alert-text: #856404;
            --tag-danger-bg: #f8d7da;
            --tag-danger-text: #721c24;
            --radius: 12px;
            --shadow-sm: 0 2px 4px rgba(0,0,0,0.02);
            --shadow-md: 0 8px 16px rgba(0,0,0,0.04);
        }

        * { box-sizing: border-box; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-body);
            color: var(--text-primary);
            margin: 0;
            padding-bottom: 60px;
        }

        header {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            position: sticky;
            top: 0;
            z-index: 100;
            border-bottom: 1px solid rgba(0,0,0,0.05);
            padding: 20px 0;
            margin-bottom: 30px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 20px;
        }

        .header-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        h1 {
            font-size: 1.5rem;
            font-weight: 800;
            margin: 0;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .control-bar {
            display: grid;
            grid-template-columns: 1fr auto;
            gap: 20px;
            align-items: center;
        }

        .search-wrapper { position: relative; }
        .search-wrapper i {
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-secondary);
        }

        input[type="text"] {
            width: 100%;
            padding: 12px 12px 12px 45px;
            border: 1px solid #e0e0e0;
            border-radius: var(--radius);
            font-size: 1rem;
            background: var(--bg-body);
        }
        input[type="text"]:focus {
            outline: none;
            border-color: var(--accent-color);
            background: #fff;
            box-shadow: 0 0 0 4px rgba(13, 110, 253, 0.1);
        }

        .toggles { display: flex; gap: 15px; }
        .toggle-btn {
            cursor: pointer;
            padding: 8px 16px;
            border-radius: 50px;
            border: 1px solid #e0e0e0;
            background: #fff;
            font-size: 0.9rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 6px;
            user-select: none;
        }
        .toggle-btn:hover { background: #f1f1f1; }
        .toggle-btn.active {
            background: var(--text-primary);
            color: #fff;
            border-color: var(--text-primary);
        }

        .active-filters {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 15px;
            min-height: 32px;
        }

        .filter-chip {
            background: var(--tag-sys-bg);
            color: var(--tag-sys-text);
            padding: 4px 12px;
            border-radius: 6px;
            font-size: 0.85rem;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
        }
        .filter-chip:hover { opacity: 0.8; }

        #catalog-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(380px, 1fr));
            gap: 24px;
        }

        .card {
            background: var(--bg-card);
            border-radius: var(--radius);
            border: 1px solid rgba(0,0,0,0.04);
            box-shadow: var(--shadow-sm);
            padding: 24px;
            display: flex;
            flex-direction: column;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        .card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-md);
            border-color: rgba(0,0,0,0.08);
            z-index: 10;
        }

        .card-header { margin-bottom: 12px; }
        .card-title {
            font-size: 1.15rem;
            font-weight: 700;
            margin: 0;
            line-height: 1.4;
            color: var(--text-primary);
        }

        .card-desc {
            font-size: 0.95rem;
            color: var(--text-secondary);
            margin-bottom: 20px;
            line-height: 1.6;
            display: -webkit-box;
            -webkit-line-clamp: 3;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .meta-row { margin-top: auto; display: flex; flex-direction: column; gap: 12px; }
        .tag-row { display: flex; flex-wrap: wrap; gap: 8px; }

        .tag {
            font-size: 0.75rem;
            padding: 4px 8px;
            border-radius: 6px;
            font-weight: 600;
            text-transform: uppercase;
            cursor: default;
        }

        /* Tooltips */
        .tag-sys {
            background: var(--tag-sys-bg);
            color: var(--tag-sys-text);
            cursor: pointer;
            transition: background 0.2s;
            position: relative;
        }
        .tag-sys:hover { background: #d0e4ff; }

        .tag-sys .custom-tooltip {
            visibility: hidden;
            width: 250px;
            background-color: #333;
            color: #fff;
            text-align: left;
            border-radius: 8px;
            padding: 12px;
            position: absolute;
            z-index: 999;
            bottom: 125%;
            left: 50%;
            transform: translateX(-50%);
            opacity: 0;
            transition: opacity 0.3s;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            font-weight: 400;
            text-transform: none;
            letter-spacing: normal;
            pointer-events: none;
        }
        .tag-sys .custom-tooltip::after {
            content: "";
            position: absolute;
            top: 100%;
            left: 50%;
            margin-left: -5px;
            border-width: 5px;
            border-style: solid;
            border-color: #333 transparent transparent transparent;
        }
        .tag-sys:hover .custom-tooltip { visibility: visible; opacity: 1; }

        .tt-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 4px;
            font-size: 0.9rem;
            font-weight: 700;
            color: #fff;
        }
        .tt-abbr {
            background: rgba(255,255,255,0.2);
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 0.75rem;
            font-family: monospace;
        }
        .tt-desc { font-size: 0.8rem; color: #ddd; line-height: 1.4; }

        .tag-personal { background: var(--tag-alert-bg); color: var(--tag-alert-text); }
        .tag-sensitive { background: var(--tag-danger-bg); color: var(--tag-danger-text); }

        .org-footer {
            border-top: 1px solid #f0f0f0;
            padding-top: 12px;
            font-size: 0.85rem;
            color: var(--text-secondary);
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .org-link {
            color: var(--text-secondary);
            font-weight: 600;
            text-decoration: none;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            transition: color 0.2s;
        }
        .org-link:hover { color: var(--accent-color); }

        .address-link {
            color: #999;
            text-decoration: none;
            font-size: 0.8rem;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }
        .address-link:hover { color: var(--text-primary); text-decoration: underline; }

        #status-msg {
            text-align: center;
            padding: 60px;
            color: var(--text-secondary);
            font-size: 1.1rem;
            grid-column: 1 / -1;
        }

        .spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(0,0,0,0.1);
            border-radius: 50%;
            border-top-color: var(--accent-color);
            animation: spin 1s ease-in-out infinite;
            margin-right: 10px;
            vertical-align: middle;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        @media (max-width: 768px) {
            .control-bar { grid-template-columns: 1fr; }
            .toggles { flex-wrap: wrap; }
        }
    </style>
</head>
<body>

<header>
    <div class="container">
        <div class="header-top">
            <h1><i class="bi bi-diagram-3-fill" style="color: var(--accent-color);"></i> LINDAS System Map</h1>
            <span style="font-size: 0.9rem; color: var(--text-secondary);" id="count-display">Loading...</span>
        </div>

        <div class="control-bar">
            <div class="search-wrapper">
                <i class="bi bi-search"></i>
                <input type="text" id="search-input" placeholder="Search datasets, descriptions, systems...">
            </div>

            <div class="toggles">
                <div class="toggle-btn" id="btn-personal" onclick="toggleState('personal')">
                    <i class="bi bi-person-exclamation"></i> Personal Data
                </div>
                <div class="toggle-btn" id="btn-sensitive" onclick="toggleState('sensitive')">
                    <i class="bi bi-shield-lock-fill"></i> Sensitive
                </div>
            </div>
        </div>

        <div id="active-filters" class="active-filters"></div>
    </div>
</header>

<div class="container">
    <div id="catalog-grid">
        <div id="status-msg">
            <div class="spinner"></div> Connecting to Linked Data Cloud...
        </div>
    </div>
</div>

<script>
    const ENDPOINT = "https://lindas.admin.ch/query";

    const SPARQL_QUERY = `
    PREFIX schema: <http://schema.org/>
    PREFIX systemmap: <https://agriculture.ld.admin.ch/system-map/>
    PREFIX rdfs: <http://www.w3.org/2000/01/rdf-schema#>
    PREFIX termdat: <https://register.ld.admin.ch/termdat/>
    PREFIX owl: <http://www.w3.org/2002/07/owl#>
    PREFIX dcterms: <http://purl.org/dc/terms/>

    CONSTRUCT {
      ?dataset a schema:Dataset ;
        schema:name ?datasetName ;
        schema:description ?datasetDesc ;
        systemmap:isPersonal ?isPersonal ;
        systemmap:isSensitive ?isSensitive ;
        systemmap:inSystem ?directSystem .

      ?directSystem a schema:SoftwareApplication ;
        schema:name ?systemName ;
        schema:description ?systemDesc ;
        systemmap:abbreviation ?systemAbbr ;
        dcterms:isPartOf ?parentSystem ;
        schema:provider ?org .

      ?parentSystem a schema:SoftwareApplication ;
        schema:name ?parentName ;
        schema:description ?parentDesc ;
        systemmap:abbreviation ?parentAbbr ;
        dcterms:isPartOf ?grandparentSystem .

      ?org a schema:Organization ;
        schema:name ?orgName ;
        schema:address ?orgAddress .
    }
    WHERE {
        ?directSystem a schema:SoftwareApplication ;
                      dcterms:hasPart*/systemmap:contains ?dataset .

        ?dataset rdfs:label ?datasetName .
        FILTER(LANG(?datasetName) = "de")

        OPTIONAL {
            ?dataset rdfs:comment|schema:description ?datasetDesc .
            FILTER(LANG(?datasetDesc) = "de")
        }

        BIND(EXISTS { ?dataset a termdat:52451 } AS ?isPersonal)
        BIND(EXISTS { ?dataset a termdat:52453 } AS ?isSensitive)

        # Get System Hierarchy
        ?directSystem dcterms:isPartOf* ?s .
        ?s rdfs:label ?systemName .
        FILTER(LANG(?systemName) = "de")

        OPTIONAL { ?s systemmap:abbreviation ?systemAbbr . FILTER(LANG(?systemAbbr)="de") }
        OPTIONAL { ?s schema:description ?systemDesc . FILTER(LANG(?systemDesc)="de") }

        OPTIONAL { ?s dcterms:isPartOf ?parentSystem . }
        FILTER(?s = ?directSystem || ?s = ?parentSystem || ?s = ?grandparentSystem)

        # Organization Traversal
        OPTIONAL {
            ?directSystem dcterms:isPartOf* ?pathSystem .
            ?pathSystem systemmap:operatedBy ?operator .
            ?operator schema:parentOrganization* ?org .
            FILTER(NOT EXISTS { ?org schema:parentOrganization ?grandparent })
            ?org rdfs:label ?orgName .
            FILTER(LANG(?orgName) = "de")

            OPTIONAL {
                { ?org schema:address ?addrNode } UNION { ?org owl:sameAs/schema:address ?addrNode }
                ?addrNode schema:streetAddress ?street ;
                          schema:postalCode ?zip ;
                          schema:addressLocality ?city .
                BIND(CONCAT(?street, ", ", ?zip, " ", ?city) AS ?orgAddress)
            }
        }
    }
    `;

    const FRAME = {
        "@context": {
            "schema": "http://schema.org/",
            "systemmap": "https://agriculture.ld.admin.ch/system-map/",
            "rdfs": "http://www.w3.org/2000/01/rdf-schema#",
            "dcterms": "http://purl.org/dc/terms/"
        },
        "@type": "schema:Dataset",
        "systemmap:inSystem": {
            "@embed": "@always",
            "@type": "schema:SoftwareApplication",
            "dcterms:isPartOf": {
                 "@embed": "@always",
                 "@type": "schema:SoftwareApplication",
                 "dcterms:isPartOf": {
                     "@embed": "@always",
                     "@type": "schema:SoftwareApplication"
                 }
            },
            "schema:provider": {
                "@embed": "@always",
                "@type": "schema:Organization"
            }
        }
    };

    let flatItems = [];
    let state = {
        search: '',
        personal: false,
        sensitive: false,
        filterSystem: null,
        filterOrg: null
    };

    async function init() {
        try {
            const rawJsonLd = await fetchSparql(SPARQL_QUERY);
            const framed = await jsonld.frame(rawJsonLd, FRAME);

            const rawDatasets = framed["@graph"] || [];
            const datasets = Array.isArray(rawDatasets) ? rawDatasets : [rawDatasets];

            flatItems = datasets.flatMap(ds => {
                let systems = ds["systemmap:inSystem"];
                if (!systems) return [];
                if (!Array.isArray(systems)) systems = [systems];

                return systems.flatMap(sys => {
                    let providers = sys["schema:provider"];
                    if (!providers) {
                        return [{ dataset: ds, system: sys, org: null }];
                    }
                    if (!Array.isArray(providers)) providers = [providers];

                    return providers.map(org => ({
                        dataset: ds,
                        system: sys,
                        org: org
                    }));
                });
            });

            document.getElementById('search-input').addEventListener('input', (e) => {
                state.search = e.target.value.toLowerCase();
                render();
            });

            render();

        } catch (e) {
            document.getElementById('catalog-grid').innerHTML =
                `<div id="status-msg" style="color:red">Error: ${e.message}</div>`;
            console.error(e);
        }
    }

    function render() {
        document.getElementById('btn-personal').classList.toggle('active', state.personal);
        document.getElementById('btn-sensitive').classList.toggle('active', state.sensitive);
        renderActiveFilters();

        const filtered = flatItems.filter(item => {
            const { dataset, system, org } = item;

            const title = (getValue(dataset["schema:name"]) || "").toLowerCase();
            const desc = (getValue(dataset["schema:description"]) || "").toLowerCase();
            const orgName = org ? (getValue(org["schema:name"]) || "Unknown Org") : "Unknown Org";

            let hierarchyNames = getAllSystemNames(system).join(" ").toLowerCase();

            const matchesText = title.includes(state.search) ||
                                desc.includes(state.search) ||
                                hierarchyNames.includes(state.search);

            if (!matchesText) return false;

            const isPersonal = getValue(dataset["systemmap:isPersonal"]) === true || getValue(dataset["systemmap:isPersonal"]) === "true";
            const isSensitive = getValue(dataset["systemmap:isSensitive"]) === true || getValue(dataset["systemmap:isSensitive"]) === "true";

            if (state.personal && !isPersonal) return false;
            if (state.sensitive && !isSensitive) return false;

            if (state.filterSystem) {
                const names = getAllSystemNames(system);
                if (!names.includes(state.filterSystem)) return false;
            }
            if (state.filterOrg && orgName !== state.filterOrg) return false;

            return true;
        });

        const grid = document.getElementById('catalog-grid');
        const count = document.getElementById('count-display');

        count.innerText = `${filtered.length} entries found`;
        grid.innerHTML = '';

        if (filtered.length === 0) {
            grid.innerHTML = `<div id="status-msg">No results match your criteria.</div>`;
            return;
        }

        filtered.forEach(item => grid.appendChild(createCard(item)));
    }

    function renderActiveFilters() {
        const container = document.getElementById('active-filters');
        container.innerHTML = '';
        const addChip = (text, onClick) => {
            const chip = document.createElement('div');
            chip.className = 'filter-chip';
            chip.innerHTML = `${text} <i class="bi bi-x"></i>`;
            chip.onclick = onClick;
            container.appendChild(chip);
        };
        if (state.filterSystem) addChip(`System: ${state.filterSystem}`, () => setFilter('system', null));
        if (state.filterOrg) addChip(`Org: ${state.filterOrg}`, () => setFilter('org', null));
    }

    function getSystemHierarchy(systemNode) {
        let hierarchy = [];
        let current = systemNode;
        while(current) {
            hierarchy.push(current);
            let parent = current["dcterms:isPartOf"];
            if (Array.isArray(parent)) parent = parent[0];
            current = parent;
        }
        return hierarchy.reverse();
    }

    function getAllSystemNames(systemNode) {
        return getSystemHierarchy(systemNode).map(s => getValue(s["schema:name"]));
    }

    function createCard(item) {
        const { dataset, system, org } = item;

        const title = getValue(dataset["schema:name"]) || "Untitled";
        const desc = getValue(dataset["schema:description"]) || "No description available.";

        const isPersonal = getValue(dataset["systemmap:isPersonal"]) === true || getValue(dataset["systemmap:isPersonal"]) === "true";
        const isSensitive = getValue(dataset["systemmap:isSensitive"]) === true || getValue(dataset["systemmap:isSensitive"]) === "true";

        const orgName = org ? (getValue(org["schema:name"]) || "Unknown Org") : "Unknown Org";
        const orgAddress = org ? getValue(org["schema:address"]) : null;

        // Corrected URL interpolation
        const mapsUrl = orgAddress
            ? `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(orgAddress)}`
            : '#';

        const systemNodes = getSystemHierarchy(system);

        // Using data attributes for click handling to prevent quoting errors
        const tagsHtml = systemNodes.map(node => {
            const name = getValue(node["schema:name"]);
            const abbr = getValue(node["systemmap:abbreviation"]);
            const sysDesc = getValue(node["schema:description"]) || "No description.";

            return `
            <span class="tag tag-sys"
                  data-name="${escapeHtml(name)}"
                  onclick="setFilter('system', this.dataset.name)"
                  style="margin-right:0;">
                <i class="bi bi-cpu"></i> ${escapeHtml(name)}
                <div class="custom-tooltip">
                    <div class="tt-header">
                        <span>
                          ${escapeHtml(name)}
                          ${abbr ? `(${escapeHtml(abbr)})` : ''}
                        </span>
                    </div>
                    <div class="tt-desc">${escapeHtml(sysDesc)}</div>
                </div>
            </span>`;
        }).join('<span style="color:#ccc; font-size: 0.8rem; display:flex; align-items:center;">&nbsp;/&nbsp;</span>');

        const card = document.createElement('div');
        card.className = 'card';
        card.innerHTML = `
            <div class="card-header">
                <h3 class="card-title">${escapeHtml(title)}</h3>
            </div>
            <div class="card-desc">
                ${escapeHtml(desc)}
            </div>

            <div class="meta-row">
                <div class="tag-row">
                    ${tagsHtml}
                    ${isPersonal ? `<span class="tag tag-personal"><i class="bi bi-person"></i> Personal</span>` : ''}
                    ${isSensitive ? `<span class="tag tag-sensitive"><i class="bi bi-shield-lock"></i> Sensitive</span>` : ''}
                </div>

                <div class="org-footer">
                    <span class="org-link"
                          data-org="${escapeHtml(orgName)}"
                          onclick="setFilter('org', this.dataset.org)">
                        <i class="bi bi-building"></i> ${escapeHtml(orgName)}
                    </span>
                    ${orgAddress ? `
                        <a href="${mapsUrl}" target="_blank" class="address-link">
                            <i class="bi bi-geo-alt"></i> ${escapeHtml(orgAddress)}
                        </a>
                    ` : ''}
                </div>
            </div>
        `;
        return card;
    }

    function toggleState(key) { state[key] = !state[key]; render(); }

    window.setFilter = function(type, value) {
        if (type === 'system') state.filterSystem = value;
        if (type === 'org') state.filterOrg = value;
        render();
    };

    async function fetchSparql(query) {
        const url = new URL(ENDPOINT);
        url.searchParams.append('query', query);
        const res = await fetch(url, { headers: { 'Accept': 'application/ld+json' } });
        if (!res.ok) throw new Error(res.statusText);
        return await res.json();
    }

    function getValue(prop) {
        if (prop === undefined || prop === null) return null;
        if (prop === false) return false;
        if (Array.isArray(prop)) return getValue(prop[0]);
        if (typeof prop === 'object' && prop['@value'] !== undefined) return prop['@value'];
        return prop;
    }

    // Robust HTML Escaping
    function escapeHtml(str) {
        if (!str) return '';
        return String(str)
            .replace(/&/g, "&amp;")
            .replace(/</g, "&lt;")
            .replace(/>/g, "&gt;")
            .replace(/"/g, "&quot;")
            .replace(/'/g, "&#39;");
    }

    init();
</script>
</body>
</html>
